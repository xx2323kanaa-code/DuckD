<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>DUCK MODE – Camera + COCO + Babylon</title>

<!-- TF + COCO -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<!-- Babylon -->
<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>

<style>
html,body{margin:0;padding:0;background:#111;color:#fff;font-family:system-ui}
#video{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;display:none}
#duckCanvas{
  position:fixed;bottom:20px;left:50%;
  transform:translateX(-50%);
  width:260px;height:260px;
  display:none;z-index:50;
}
#hudBtn{
  position:fixed;top:10px;right:10px;z-index:100;
}
#hud{
  position:fixed;top:50px;right:10px;
  width:320px;max-height:45vh;
  background:rgba(0,0,0,.7);
  border:1px solid #555;border-radius:8px;
  padding:8px;font-size:12px;
  display:none;overflow:auto;
}
button{padding:6px 10px;margin:4px}
</style>
</head>

<body>

<video id="video" autoplay playsinline muted></video>
<canvas id="duckCanvas"></canvas>

<button id="hudBtn">≡</button>

<div id="hud">
  <button id="copyHud">Copy</button>
  <button id="reset">Reset</button>
  <pre id="hudText">IDLE</pre>
</div>

<button id="startCam" style="position:fixed;bottom:20px;left:20px">
Start Camera
</button>

<script>
/* =======================
   STATE
======================= */
let state="IDLE"; // IDLE | SCAN | FREEZE | DUCK
let stream=null, model=null;
let hudLines=[];

/* =======================
   HUD
======================= */
const hud=document.getElementById("hud");
const hudText=document.getElementById("hudText");
document.getElementById("hudBtn").onclick=()=>{
  hud.style.display = hud.style.display==="none"?"block":"none";
};
function log(line){
  hudLines.push(line);
  if(hudLines.length>40) hudLines.shift();
  hudText.textContent=hudLines.join("\n");
}
document.getElementById("copyHud").onclick=()=>{
  navigator.clipboard.writeText(hudText.textContent);
};

/* =======================
   CAMERA
======================= */
const video=document.getElementById("video");

async function startCamera(){
  stream=await navigator.mediaDevices.getUserMedia({
    video:{facingMode:"environment",width:640,height:480},
    audio:false
  });
  video.srcObject=stream;
  video.style.display="block";
  state="SCAN";
  log("Camera started");
}

function freezeCamera(){
  stream.getVideoTracks()[0].enabled=false;
  state="FREEZE";
  log("Camera frozen");
}

function stopCamera(){
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream=null;
  }
  video.style.display="none";
}

/* =======================
   COCO
======================= */
async function loadCoco(){
  await tf.setBackend("webgl");
  await tf.ready();
  model=await cocoSsd.load();
  log("COCO loaded");
}

function group(cls){
  cls=cls.toLowerCase();
  if(["pen","knife","scissors","fork","spoon","toothbrush"].includes(cls)) return "pen";
  if(["cell phone","wallet","book"].includes(cls)) return "phone";
  return "none";
}

async function detect(){
  if(state!=="SCAN"||!model) return;
  const preds=await model.detect(video);
  let best={score:0,group:"none"};
  preds.forEach(p=>{
    const g=group(p.class);
    if(g!=="none"&&p.score>best.score){
      best={score:p.score,group:g};
    }
  });
  if(best.score>0.45){
    log(`DETECT ${best.group} ${best.score.toFixed(2)}`);
    freezeCamera();
    showDuck();
  }
}

/* =======================
   BABYLON DUCK
======================= */
let engine,scene;

function showDuck(){
  const canvas=document.getElementById("duckCanvas");
  canvas.style.display="block";
  engine=new BABYLON.Engine(canvas,true);
  scene=new BABYLON.Scene(engine);

  const cam=new BABYLON.ArcRotateCamera(
    "c",Math.PI/2,Math.PI/3,2,BABYLON.Vector3.Zero(),scene
  );
  cam.attachControl(canvas,true);
  new BABYLON.HemisphericLight("l",new BABYLON.Vector3(1,1,0),scene);

  BABYLON.SceneLoader.Append("./","duck.glb",scene,()=>{
    engine.runRenderLoop(()=>scene.render());
  });
  state="DUCK";
  log("DUCK MODE");
}

/* =======================
   LOOP
======================= */
async function loop(){
  await detect();
  setTimeout(loop,150);
}

/* =======================
   RESET
======================= */
document.getElementById("reset").onclick=()=>{
  if(engine){engine.dispose();engine=null;}
  document.getElementById("duckCanvas").style.display="none";
  if(stream) stream.getVideoTracks()[0].enabled=true;
  state="SCAN";
  log("RESET");
};

/* =======================
   INIT
======================= */
document.getElementById("startCam").onclick=async()=>{
  await startCamera();
  await loadCoco();
  loop();
};
</script>
</body>
</html>
