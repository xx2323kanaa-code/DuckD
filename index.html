<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>Colorful Japand</title>

<!-- TensorFlow + COCO -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<!-- Babylon -->
<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>

<style>
html,body{margin:0;padding:0;background:#111;color:#fff;font-family:system-ui}

/* Title */
#title{ text-align:center; font-size:20px; font-weight:700; padding:10px; }

/* Circle */
#wrap{ width:100%; display:flex; justify-content:center; margin-top:6px; }
#circle{
  position:relative;
  width:72vw; max-width:360px; aspect-ratio:1;
  border-radius:50%; overflow:hidden; background:#000;
}

/* Camera video */
#video{
  position:absolute; inset:0; width:100%; height:100%;
  object-fit:cover; display:none;
}

/* Hand PNG (covers entire circle) */
#handImg{
  position:absolute; inset:0; width:100%; height:100%;
  object-fit:contain; display:none; pointer-events:none;
}

/* Duck canvas: clipped to lower half of circle */
#duckCanvas{
  position:absolute; left:0; right:0; bottom:0;
  height:50%; width:100%;
  display:none; opacity:0.55;
  pointer-events:auto;
}

/* Controls */
#controls{ display:flex; justify-content:center; gap:12px; margin:14px; }
button{ padding:8px 14px; border-radius:8px; border:none; background:#333; color:#fff; }

/* HUD */
#menuBtn{ position:fixed; top:10px; right:10px; z-index:100; }
#hud{
  position:fixed; top:50px; right:10px;
  width:320px; max-height:45vh;
  background:rgba(0,0,0,.75);
  border:1px solid #444; border-radius:10px;
  padding:8px; font-size:12px; display:none; overflow:auto;
}
#hud button{ width:100%; margin-bottom:6px; }
pre{ white-space:pre-wrap; word-break:break-word; }
</style>
</head>

<body>

<div id="title">Colorful Japand</div>

<div id="wrap">
  <div id="circle">
    <video id="video" autoplay muted playsinline></video>
    <img id="handImg" src="hand_open.png" alt="prosthetic hand">
    <canvas id="duckCanvas"></canvas>
  </div>
</div>

<div id="controls">
  <button id="startBtn">Start Camera</button>
  <button id="resetBtn">Reset</button>
</div>

<button id="menuBtn">â‰¡</button>
<div id="hud">
  <button id="copyHud">Copy HUD</button>
  <pre id="hudText">IDLE</pre>
</div>

<script>
/* ========= STATE ========= */
let state="IDLE"; // IDLE | SCAN | FREEZE
let stream=null, model=null;
let hudLines=[];

/* ========= HUD ========= */
const hud=document.getElementById("hud");
const hudText=document.getElementById("hudText");
document.getElementById("menuBtn").onclick=()=>{
  hud.style.display = hud.style.display==="none"?"block":"none";
};
function log(line){
  hudLines.unshift(line);
  if(hudLines.length>40) hudLines.pop();
  hudText.textContent=hudLines.join("\n");
}
document.getElementById("copyHud").onclick=async()=>{
  await navigator.clipboard.writeText(hudText.textContent);
};

/* ========= CAMERA ========= */
const video=document.getElementById("video");
async function startCamera(){
  stream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:"environment", width:640, height:480 }, audio:false
  });
  video.srcObject=stream;
  video.style.display="block";
  state="SCAN";
  log("Camera started");
}
function freezeCamera(){
  if(stream){ stream.getVideoTracks()[0].enabled=false; }
  log("Camera frozen");
}

/* ========= COCO ========= */
async function loadCoco(){
  await tf.setBackend("webgl"); await tf.ready();
  model = await cocoSsd.load();
  log("COCO loaded");
}
function groupOf(cls){
  cls=cls.toLowerCase();
  if(["pen","knife","scissors","fork","spoon","toothbrush"].includes(cls)) return "pen";
  if(["cell phone","wallet","book"].includes(cls)) return "phone";
  return "none";
}
async function detect(){
  if(state!=="SCAN"||!model) return;
  const preds = await model.detect(video);
  let best=null;
  preds.forEach(p=>{
    const g=groupOf(p.class);
    if(g!=="none" && (!best||p.score>best.score)){
      best={g,score:p.score};
    }
  });
  if(best && best.score>=0.5){
    log(`DETECT ${best.g} ${best.score.toFixed(2)}`);
    freezeCamera();
    showFreezeViews();
  }
}

/* ========= HAND + DUCK ========= */
const handImg=document.getElementById("handImg");
const duckCanvas=document.getElementById("duckCanvas");
let engine=null, scene=null;

function showFreezeViews(){
  // Show hand PNG
  handImg.style.display="block";
  // Show duck (Babylon) in lower half
  duckCanvas.style.display="block";
  startDuck();
  state="FREEZE";
  log("FREEZE: HAND + DUCK");
}

function startDuck(){
  if(engine){ engine.dispose(); engine=null; }
  engine = new BABYLON.Engine(duckCanvas,true,{ preserveDrawingBuffer:true, stencil:true });
  scene  = new BABYLON.Scene(engine);
  const cam = new BABYLON.ArcRotateCamera(
    "c", Math.PI/2, Math.PI/3, 2.2, BABYLON.Vector3.Zero(), scene
  );
  cam.attachControl(duckCanvas,true);
  new BABYLON.HemisphericLight("l", new BABYLON.Vector3(1,1,0), scene);
  BABYLON.SceneLoader.Append("./","duck.glb",scene,()=>{
    engine.runRenderLoop(()=>scene.render());
  });
}

/* ========= LOOP ========= */
async function loop(){
  await detect();
  setTimeout(loop,150);
}

/* ========= RESET ========= */
document.getElementById("resetBtn").onclick=()=>{
  handImg.style.display="none";
  duckCanvas.style.display="none";
  if(engine){ engine.dispose(); engine=null; }
  if(stream){ stream.getVideoTracks()[0].enabled=true; }
  state="SCAN";
  log("RESET");
};

/* ========= INIT ========= */
document.getElementById("startBtn").onclick=async()=>{
  await startCamera();
  await loadCoco();
  loop();
};
</script>

</body>
</html>
